b4293fcd2f4aecaae27bc2a7c578061c
"use strict";

var path = require('path');

var process = require('process');

var walk = require('walk');

var util = require('./util');

var _require = require('child_process'),
    exec = _require.exec;

var specDir = path.join(__dirname, 'language-spec'); // TODO: Replace me.

function getFolderName(filePath) {
  // windows
  if (filePath.indexOf('/') == -1) {
    return filePath.substring(filePath.lastIndexOf('\\') + 1, filePath.length);
  } // unix


  return filePath.substring(filePath.lastIndexOf('/') + 1, filePath.length);
} // Returns a promise to a map of records containing
// { specFileDir: { missingExpectFile: bool, missingSourceFile: bool }}


function getSpecFiles(specPath) {
  return new Promise(function (resolve) {
    var testDirs = {};
    var skywalker = walk.walk(specPath); // Walk every folder in the file tree adding any folders that;
    // have an expect.js and have a source.js

    skywalker.on('names', function (fpath, children) {
      var missingExpectFile = children.indexOf('expect.js') === -1;
      var missingSourceFile = children.indexOf('source.djs') === -1; // Could throw an error here for invalid test format

      if (missingExpectFile || missingSourceFile) return;
      testDirs[fpath] = {
        missingExpectFile: missingExpectFile,
        missingSourceFile: missingSourceFile
      };
    });
    skywalker.on('end', function () {
      resolve(testDirs);
    });
  });
} // Build our project for E2E testing


function buildProject() {
  var ROOT_DIR = path.join(__dirname, '..');
  var buildCommand = "npm run build";
  console.log("\n\nðŸ›   Building dogescript...\n");
  return new Promise(function (resolve, reject) {
    /**
     * Compile the binary for testing
     */
    exec("cd ".concat(ROOT_DIR, " && ").concat(buildCommand), {
      encoding: 'UTF-8'
    }, function (error, stdout, stderr) {
      var errorOutput = stderr.toString();
      var stdOutput = stdout.toString();
      var errMsg = "Failed to start testing suite, compiler build failed";

      if (error || errorOutput) {
        console.error(errorOutput);
        console.error(stdOutput);
        console.error(errMsg);
        reject([new Error(errMsg), stdOutput, errorOutput]);
      }

      resolve();
    });
  });
} // Takes a specFileMapping and transforms it into a serializable format
// For the test suite to use (globals are not permitted)


function formatSpecMetadata(testDirMapping) {
  return Object.keys(testDirMapping).map(function (dir) {
    var testName = getFolderName(dir); // Separate by directory if it wasnt a directory with a name-like-this

    if (!testName.includes('-')) {
      var relative = path.relative(specDir, dir);
      testName = relative.split(path.sep).join('-');
    }

    return [testName, dir];
  });
} // setup.js, global setup for jest


module.exports = function () {
  return getSpecFiles(specDir).then(formatSpecMetadata).then(function (specMetadata) {
    util.writeTmpFile('specMetadata.json', JSON.stringify(specMetadata));
  }).then(buildProject);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNldHVwLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwicHJvY2VzcyIsIndhbGsiLCJ1dGlsIiwiZXhlYyIsInNwZWNEaXIiLCJqb2luIiwiX19kaXJuYW1lIiwiZ2V0Rm9sZGVyTmFtZSIsImZpbGVQYXRoIiwiaW5kZXhPZiIsInN1YnN0cmluZyIsImxhc3RJbmRleE9mIiwibGVuZ3RoIiwiZ2V0U3BlY0ZpbGVzIiwic3BlY1BhdGgiLCJQcm9taXNlIiwicmVzb2x2ZSIsInRlc3REaXJzIiwic2t5d2Fsa2VyIiwib24iLCJmcGF0aCIsImNoaWxkcmVuIiwibWlzc2luZ0V4cGVjdEZpbGUiLCJtaXNzaW5nU291cmNlRmlsZSIsImJ1aWxkUHJvamVjdCIsIlJPT1RfRElSIiwiYnVpbGRDb21tYW5kIiwiY29uc29sZSIsImxvZyIsInJlamVjdCIsImVuY29kaW5nIiwiZXJyb3IiLCJzdGRvdXQiLCJzdGRlcnIiLCJlcnJvck91dHB1dCIsInRvU3RyaW5nIiwic3RkT3V0cHV0IiwiZXJyTXNnIiwiRXJyb3IiLCJmb3JtYXRTcGVjTWV0YWRhdGEiLCJ0ZXN0RGlyTWFwcGluZyIsIk9iamVjdCIsImtleXMiLCJtYXAiLCJkaXIiLCJ0ZXN0TmFtZSIsImluY2x1ZGVzIiwicmVsYXRpdmUiLCJzcGxpdCIsInNlcCIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0aGVuIiwic3BlY01ldGFkYXRhIiwid3JpdGVUbXBGaWxlIiwiSlNPTiIsInN0cmluZ2lmeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQWxCOztBQUNBLElBQUlDLE9BQU8sR0FBR0QsT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBQ0EsSUFBSUUsSUFBSSxHQUFHRixPQUFPLENBQUMsTUFBRCxDQUFsQjs7QUFDQSxJQUFJRyxJQUFJLEdBQUdILE9BQU8sQ0FBQyxRQUFELENBQWxCOztlQUNpQkEsT0FBTyxDQUFDLGVBQUQsQztJQUFoQkksSSxZQUFB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R0xGLFdBSEssQ0FBRCxDQUFOO0FBS0Q7O0FBRURsQixNQUFBQSxPQUFPO0FBQ1IsS0FqQkcsQ0FBSjtBQWtCRCxHQXRCTSxDQUFQO0FBdUJELEMsQ0FFRDtBQUNBOzs7QUFDQSxTQUFTdUIsa0JBQVQsQ0FBNEJDLGNBQTVCLEVBQTRDO0FBQzFDLFNBQU9DLE1BQU0sQ0FDVkMsSUFESSxDQUNDRixjQURELEVBRUpHLEdBRkksQ0FFQSxVQUFTQyxHQUFULEVBQWM7QUFDakIsUUFBSUMsUUFBUSxHQUFHdEMsYUFBYSxDQUFDcUMsR0FBRCxDQUE1QixDQURpQixDQUdqQjs7QUFDQSxRQUFHLENBQUNDLFFBQVEsQ0FBQ0MsUUFBVCxDQUFrQixHQUFsQixDQUFKLEVBQ0E7QUFDRSxVQUFJQyxRQUFRLEdBQUdqRCxJQUFJLENBQUNpRCxRQUFMLENBQWMzQyxPQUFkLEVBQXVCd0MsR0FBdkIsQ0FBZjtBQUNBQyxNQUFBQSxRQUFRLEdBQUdFLFFBQVEsQ0FBQ0MsS0FBVCxDQUFlbEQsSUFBSSxDQUFDbUQsR0FBcEIsRUFBeUI1QyxJQUF6QixDQUE4QixHQUE5QixDQUFYO0FBQ0Q7O0FBRUQsV0FBTyxDQUFDd0MsUUFBRCxFQUFXRCxHQUFYLENBQVA7QUFDRCxHQWJJLENBQVA7QUFjRCxDLENBRUQ7OztBQUNBTSxNQUFNLENBQUNDLE9BQVAsR0FBa0IsWUFBVztBQUMzQixTQUFPdEMsWUFBWSxDQUFDVCxPQUFELENBQVosQ0FDSmdELElBREksQ0FDQ2Isa0JBREQsRUFFSmEsSUFGSSxDQUVDLFVBQVVDLFlBQVYsRUFBd0I7QUFDNUJuRCxJQUFBQSxJQUFJLENBQUNvRCxZQUFMLENBQWtCLG1CQUFsQixFQUF1Q0MsSUFBSSxDQUFDQyxTQUFMLENBQWVILFlBQWYsQ0FBdkM7QUFDRCxHQUpJLEVBS0pELElBTEksQ0FLQzVCLFlBTEQsQ0FBUDtBQU1ELENBUEQiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxudmFyIHByb2Nlc3MgPSByZXF1aXJlKCdwcm9jZXNzJyk7XHJcbnZhciB3YWxrID0gcmVxdWlyZSgnd2FsaycpO1xyXG52YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpO1xyXG5jb25zdCB7IGV4ZWMgfSA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTtcclxuXHJcblxyXG52YXIgc3BlY0RpciA9IHBhdGguam9pbihfX2Rpcm5hbWUsICdsYW5ndWFnZS1zcGVjJyk7XHJcblxyXG4vLyBUT0RPOiBSZXBsYWNlIG1lLlxyXG5mdW5jdGlvbiBnZXRGb2xkZXJOYW1lKGZpbGVQYXRoKSB7XHJcbiAgLy8gd2luZG93c1xyXG4gIGlmIChmaWxlUGF0aC5pbmRleE9mKCcvJykgPT0gLTEpIHtcclxuICAgIHJldHVybiBmaWxlUGF0aC5zdWJzdHJpbmcoZmlsZVBhdGgubGFzdEluZGV4T2YoJ1xcXFwnKSArIDEsIGZpbGVQYXRoLmxlbmd0aCk7XHJcbiAgfVxyXG5cclxuICAvLyB1bml4XHJcbiAgcmV0dXJuIGZpbGVQYXRoLnN1YnN0cmluZyhmaWxlUGF0aC5sYXN0SW5kZXhPZignLycpICsgMSwgZmlsZVBhdGgubGVuZ3RoKTtcclxufVxyXG5cclxuLy8gUmV0dXJucyBhIHByb21pc2UgdG8gYSBtYXAgb2YgcmVjb3JkcyBjb250YWluaW5nXHJcbi8vIHsgc3BlY0ZpbGVEaXI6IHsgbWlzc2luZ0V4cGVjdEZpbGU6IGJvb2wsIG1pc3NpbmdTb3VyY2VGaWxlOiBib29sIH19XHJcbmZ1bmN0aW9uIGdldFNwZWNGaWxlcyhzcGVjUGF0aCkge1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwpIHtcclxuICAgICAgdmFyIHRlc3REaXJzID0ge307XHJcbiAgICAgIHZhciBza3l3YWxrZXIgPSB3YWxrLndhbGsoc3BlY1BhdGgpO1xyXG5cclxuICAgICAgLy8gV2FsayBldmVyeSBmb2xkZXIgaW4gdGhlIGZpbGUgdHJlZSBhZGRpbmcgYW55IGZvbGRlcnMgdGhhdDtcclxuICAgICAgLy8gaGF2ZSBhbiBleHBlY3QuanMgYW5kIGhhdmUgYSBzb3VyY2UuanNcclxuICAgICAgc2t5d2Fsa2VyLm9uKCduYW1lcycsIGZ1bmN0aW9uKGZwYXRoLCBjaGlsZHJlbikge1xyXG4gICAgICAgIHZhciBtaXNzaW5nRXhwZWN0RmlsZSA9IGNoaWxkcmVuLmluZGV4T2YoJ2V4cGVjdC5qcycpID09PSAtMTtcclxuICAgICAgICB2YXIgbWlzc2luZ1NvdXJjZUZpbGUgPSBjaGlsZHJlbi5pbmRleE9mKCdzb3VyY2UuZGpzJykgPT09IC0xO1xyXG5cclxuICAgICAgICAvLyBDb3VsZCB0aHJvdyBhbiBlcnJvciBoZXJlIGZvciBpbnZhbGlkIHRlc3QgZm9ybWF0XHJcbiAgICAgICAgaWYobWlzc2luZ0V4cGVjdEZpbGUgfHwgbWlzc2luZ1NvdXJjZUZpbGUpIHJldHVybjtcclxuXHJcbiAgICAgICAgdGVzdERpcnNbZnBhdGhdID0geyBtaXNzaW5nRXhwZWN0RmlsZSwgbWlzc2luZ1NvdXJjZUZpbGUgfTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBza3l3YWxrZXIub24oJ2VuZCcsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJlc29sdmUodGVzdERpcnMpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn1cclxuXHJcbi8vIEJ1aWxkIG91ciBwcm9qZWN0IGZvciBFMkUgdGVzdGluZ1xyXG5mdW5jdGlvbiBidWlsZFByb2plY3QoKSB7XHJcbiAgY29uc3QgUk9PVF9ESVIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nKTtcclxuICBjb25zdCBidWlsZENvbW1hbmQgPSBcIm5wbSBydW4gYnVpbGRcIjtcclxuXHJcbiAgY29uc29sZS5sb2coXCJcXG5cXG7wn5ugICBCdWlsZGluZyBkb2dlc2NyaXB0Li4uXFxuXCIpXHJcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIC8qKlxyXG4gICAgICogQ29tcGlsZSB0aGUgYmluYXJ5IGZvciB0ZXN0aW5nXHJcbiAgICAgKi9cclxuICAgIGV4ZWMoYGNkICR7Uk9PVF9ESVJ9ICYmICR7YnVpbGRDb21tYW5kfWAsIHsgZW5jb2Rpbmc6ICdVVEYtOCcgfSwgKGVycm9yLCBzdGRvdXQsIHN0ZGVycikgPT4ge1xyXG4gICAgICBjb25zdCBlcnJvck91dHB1dCA9IHN0ZGVyci50b1N0cmluZygpO1xyXG4gICAgICBjb25zdCBzdGRPdXRwdXQgPSBzdGRvdXQudG9TdHJpbmcoKTtcclxuICAgICAgY29uc3QgZXJyTXNnID0gXCJGYWlsZWQgdG8gc3RhcnQgdGVzdGluZyBzdWl0ZSwgY29tcGlsZXIgYnVpbGQgZmFpbGVkXCI7XHJcblxyXG4gICAgICBpZiAoZXJyb3IgfHwgZXJyb3JPdXRwdXQpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yT3V0cHV0KTtcclxuICAgICAgICBjb25zb2xlLmVycm9yKHN0ZE91dHB1dCk7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJNc2cpXHJcbiAgICAgICAgcmVqZWN0KFtcclxuICAgICAgICAgIG5ldyBFcnJvcihlcnJNc2cpLFxyXG4gICAgICAgICAgc3RkT3V0cHV0LFxyXG4gICAgICAgICAgZXJyb3JPdXRwdXQsXHJcbiAgICAgICAgXSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJlc29sdmUoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59XHJcblxyXG4vLyBUYWtlcyBhIHNwZWNGaWxlTWFwcGluZyBhbmQgdHJhbnNmb3JtcyBpdCBpbnRvIGEgc2VyaWFsaXphYmxlIGZvcm1hdFxyXG4vLyBGb3IgdGhlIHRlc3Qgc3VpdGUgdG8gdXNlIChnbG9iYWxzIGFyZSBub3QgcGVybWl0dGVkKVxyXG5mdW5jdGlvbiBmb3JtYXRTcGVjTWV0YWRhdGEodGVzdERpck1hcHBpbmcpIHtcclxuICByZXR1cm4gT2JqZWN0XHJcbiAgICAua2V5cyh0ZXN0RGlyTWFwcGluZylcclxuICAgIC5tYXAoZnVuY3Rpb24oZGlyKSB7XHJcbiAgICAgIHZhciB0ZXN0TmFtZSA9IGdldEZvbGRlck5hbWUoZGlyKTtcclxuXHJcbiAgICAgIC8vIFNlcGFyYXRlIGJ5IGRpcmVjdG9yeSBpZiBpdCB3YXNudCBhIGRpcmVjdG9yeSB3aXRoIGEgbmFtZS1saWtlLXRoaXNcclxuICAgICAgaWYoIXRlc3ROYW1lLmluY2x1ZGVzKCctJykpXHJcbiAgICAgIHtcclxuICAgICAgICB2YXIgcmVsYXRpdmUgPSBwYXRoLnJlbGF0aXZlKHNwZWNEaXIsIGRpcik7XHJcbiAgICAgICAgdGVzdE5hbWUgPSByZWxhdGl2ZS5zcGxpdChwYXRoLnNlcCkuam9pbignLScpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gW3Rlc3ROYW1lLCBkaXJdO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbi8vIHNldHVwLmpzLCBnbG9iYWwgc2V0dXAgZm9yIGplc3RcclxubW9kdWxlLmV4cG9ydHMgPSAgZnVuY3Rpb24oKSB7XHJcbiAgcmV0dXJuIGdldFNwZWNGaWxlcyhzcGVjRGlyKVxyXG4gICAgLnRoZW4oZm9ybWF0U3BlY01ldGFkYXRhKVxyXG4gICAgLnRoZW4oZnVuY3Rpb24gKHNwZWNNZXRhZGF0YSkge1xyXG4gICAgICB1dGlsLndyaXRlVG1wRmlsZSgnc3BlY01ldGFkYXRhLmpzb24nLCBKU09OLnN0cmluZ2lmeShzcGVjTWV0YWRhdGEpKTtcclxuICAgIH0pXHJcbiAgICAudGhlbihidWlsZFByb2plY3QpO1xyXG59OyJdfQ==